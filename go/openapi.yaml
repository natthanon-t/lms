openapi: 3.0.3
info:
  title: CBT LMS Backend API
  version: 1.0.0
  description: OpenAPI spec generated from current Go Fiber backend routes.
servers:
  - url: http://localhost:5020
tags:
  - name: Health
  - name: Auth
  - name: Profile
  - name: Admin Users
paths:
  /health:
    get:
      tags: [Health]
      summary: Health check
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string
                    example: ok

  /api/auth/register:
    post:
      tags: [Auth]
      summary: Register new user
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/RegisterRequest"
      responses:
        "201":
          description: Register success
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/RegisterResponse"
        "400":
          $ref: "#/components/responses/ErrorResponse"
        "409":
          $ref: "#/components/responses/ErrorResponse"
        "500":
          $ref: "#/components/responses/ErrorResponse"

  /api/auth/login:
    post:
      tags: [Auth]
      summary: Login
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/LoginRequest"
      responses:
        "200":
          description: Login success
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/AuthTokenResponse"
        "400":
          $ref: "#/components/responses/ErrorResponse"
        "401":
          $ref: "#/components/responses/ErrorResponse"
        "403":
          $ref: "#/components/responses/ErrorResponse"
        "500":
          $ref: "#/components/responses/ErrorResponse"

  /api/auth/refresh:
    post:
      tags: [Auth]
      summary: Refresh access token
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/RefreshRequest"
      responses:
        "200":
          description: Refresh success
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/AuthTokenResponse"
        "400":
          $ref: "#/components/responses/ErrorResponse"
        "401":
          $ref: "#/components/responses/ErrorResponse"
        "403":
          $ref: "#/components/responses/ErrorResponse"
        "500":
          $ref: "#/components/responses/ErrorResponse"

  /api/auth/logout:
    post:
      tags: [Auth]
      summary: Logout (revoke refresh token if provided)
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/LogoutRequest"
      responses:
        "200":
          description: Logout success
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: logout success
        "400":
          $ref: "#/components/responses/ErrorResponse"
        "500":
          $ref: "#/components/responses/ErrorResponse"

  /api/auth/me:
    get:
      tags: [Auth]
      summary: Get current user profile from access token
      security:
        - bearerAuth: []
      responses:
        "200":
          description: Current user
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/UserPayload"
        "401":
          $ref: "#/components/responses/ErrorResponse"

  /api/profile:
    patch:
      tags: [Profile]
      summary: Update current user name
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/UpdateProfileNameRequest"
      responses:
        "200":
          description: Profile updated
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: profile updated
                  user:
                    $ref: "#/components/schemas/UserPayload"
        "400":
          $ref: "#/components/responses/ErrorResponse"
        "401":
          $ref: "#/components/responses/ErrorResponse"
        "500":
          $ref: "#/components/responses/ErrorResponse"

  /api/profile/change-password:
    post:
      tags: [Profile]
      summary: Change current user password
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/ChangePasswordRequest"
      responses:
        "200":
          description: Password changed
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: password changed
        "400":
          $ref: "#/components/responses/ErrorResponse"
        "401":
          $ref: "#/components/responses/ErrorResponse"
        "500":
          $ref: "#/components/responses/ErrorResponse"

  /api/role:
    get:
      tags: [Admin Users]
      summary: Get available user roles
      security:
        - bearerAuth: []
      responses:
        "200":
          description: Role options
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/RoleOptionsResponse"
        "401":
          $ref: "#/components/responses/ErrorResponse"

  /api/users:
    get:
      tags: [Admin Users]
      summary: List all users (admin only)
      security:
        - bearerAuth: []
      responses:
        "200":
          description: Users list
          content:
            application/json:
              schema:
                type: object
                properties:
                  users:
                    type: array
                    items:
                      $ref: "#/components/schemas/AuthUser"
        "401":
          $ref: "#/components/responses/ErrorResponse"
        "403":
          $ref: "#/components/responses/ErrorResponse"
        "500":
          $ref: "#/components/responses/ErrorResponse"

  /api/users/options:
    get:
      tags: [Admin Users]
      summary: Get available role and status options for user management (admin only)
      security:
        - bearerAuth: []
      responses:
        "200":
          description: Role and status options
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/UserManagementOptionsResponse"
        "401":
          $ref: "#/components/responses/ErrorResponse"
        "403":
          $ref: "#/components/responses/ErrorResponse"
    post:
      tags: [Admin Users]
      summary: Create user (admin only)
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/AdminCreateUserRequest"
      responses:
        "201":
          description: User created
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: create user success
                  user:
                    $ref: "#/components/schemas/AuthUser"
        "400":
          $ref: "#/components/responses/ErrorResponse"
        "401":
          $ref: "#/components/responses/ErrorResponse"
        "403":
          $ref: "#/components/responses/ErrorResponse"
        "409":
          $ref: "#/components/responses/ErrorResponse"
        "500":
          $ref: "#/components/responses/ErrorResponse"

  /api/users/{username}:
    patch:
      tags: [Admin Users]
      summary: Update user by username (admin only)
      security:
        - bearerAuth: []
      parameters:
        - name: username
          in: path
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/AdminUpdateUserRequest"
      responses:
        "200":
          description: User updated
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: update user success
                  user:
                    $ref: "#/components/schemas/UserPayload"
        "400":
          $ref: "#/components/responses/ErrorResponse"
        "401":
          $ref: "#/components/responses/ErrorResponse"
        "403":
          $ref: "#/components/responses/ErrorResponse"
        "404":
          $ref: "#/components/responses/ErrorResponse"
        "500":
          $ref: "#/components/responses/ErrorResponse"

  /api/users/{username}/reset-password:
    post:
      tags: [Admin Users]
      summary: Reset user password by username (admin only)
      security:
        - bearerAuth: []
      parameters:
        - name: username
          in: path
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/AdminResetPasswordRequest"
      responses:
        "200":
          description: Password reset success
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: reset password success
        "400":
          $ref: "#/components/responses/ErrorResponse"
        "401":
          $ref: "#/components/responses/ErrorResponse"
        "403":
          $ref: "#/components/responses/ErrorResponse"
        "404":
          $ref: "#/components/responses/ErrorResponse"
        "500":
          $ref: "#/components/responses/ErrorResponse"

components:
  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT

  responses:
    ErrorResponse:
      description: Error response
      content:
        application/json:
          schema:
            $ref: "#/components/schemas/ErrorResponse"

  schemas:
    ErrorResponse:
      type: object
      properties:
        message:
          type: string
      required: [message]
      example:
        message: invalid request body

    UserPayload:
      type: object
      properties:
        id:
          type: integer
          format: int64
          example: 1
        name:
          type: string
          example: System Admin
        username:
          type: string
          example: admin
        role:
          type: string
          example: admin
        status:
          type: string
          example: active
      required: [id, name, username, role, status]

    AuthUser:
      allOf:
        - $ref: "#/components/schemas/UserPayload"
        - type: object
          properties:
            created_at:
              type: string
              format: date-time
              example: "2026-02-27T03:00:00Z"
          required: [created_at]

    RegisterRequest:
      type: object
      properties:
        name:
          type: string
        username:
          type: string
        password:
          type: string
          minLength: 8
      required: [name, username, password]

    RegisterResponse:
      type: object
      properties:
        message:
          type: string
          example: register success
        user:
          $ref: "#/components/schemas/AuthUser"
      required: [message, user]

    LoginRequest:
      type: object
      properties:
        username:
          type: string
        password:
          type: string
      required: [username, password]

    RefreshRequest:
      type: object
      properties:
        refresh_token:
          type: string
      required: [refresh_token]

    LogoutRequest:
      type: object
      properties:
        refresh_token:
          type: string
      required: [refresh_token]

    AuthTokenResponse:
      type: object
      properties:
        message:
          type: string
          example: login success
        token:
          type: string
        refresh_token:
          type: string
        token_type:
          type: string
          example: Bearer
        expires_in:
          type: integer
          description: Access token lifetime in seconds
          example: 900
        user:
          $ref: "#/components/schemas/UserPayload"
      required: [message, token, refresh_token, token_type, expires_in, user]

    UpdateProfileNameRequest:
      type: object
      properties:
        name:
          type: string
      required: [name]

    ChangePasswordRequest:
      type: object
      properties:
        current_password:
          type: string
        new_password:
          type: string
          minLength: 8
      required: [current_password, new_password]

    AdminCreateUserRequest:
      type: object
      properties:
        name:
          type: string
        username:
          type: string
        password:
          type: string
          minLength: 8
        role:
          type: string
          description: Defaults to ผู้ใช้งาน when omitted
          enum: ["ผู้ใช้งาน", "ผู้สอน", "ผู้ดูแลระบบ", "user", "admin"]
        status:
          type: string
          enum: [active, inactive]
          description: Defaults to active when omitted
      required: [name, username, password]

    AdminUpdateUserRequest:
      type: object
      properties:
        name:
          type: string
        role:
          type: string
          enum: ["ผู้ใช้งาน", "ผู้สอน", "ผู้ดูแลระบบ", "user", "admin"]
        status:
          type: string
          enum: [active, inactive]

    UserManagementOptionsResponse:
      type: object
      properties:
        role_options:
          type: array
          items:
            type: string
            enum: ["ผู้ใช้งาน", "ผู้สอน", "ผู้ดูแลระบบ", "user", "admin"]
        status_options:
          type: array
          items:
            type: string
            enum: [active, inactive]
        default_role:
          type: string
          enum: ["ผู้ใช้งาน", "ผู้สอน", "ผู้ดูแลระบบ", "user", "admin"]
          example: "ผู้ใช้งาน"
        default_status:
          type: string
          enum: [active, inactive]
          example: active
      required: [role_options, status_options, default_role, default_status]

    RoleOptionsResponse:
      type: object
      properties:
        roles:
          type: array
          items:
            type: string
            enum: ["ผู้ใช้งาน", "ผู้สอน", "ผู้ดูแลระบบ", "user", "admin"]
        default_role:
          type: string
          enum: ["ผู้ใช้งาน", "ผู้สอน", "ผู้ดูแลระบบ", "user", "admin"]
          example: "ผู้ใช้งาน"
      required: [roles, default_role]

    AdminResetPasswordRequest:
      type: object
      properties:
        new_password:
          type: string
          minLength: 8
      required: [new_password]
